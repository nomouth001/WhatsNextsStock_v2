<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 분석 - {{ ticker }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .debug-info h3 {
            margin-top: 0;
            color: #495057;
        }
        .debug-info pre {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #e9ecef;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-success { background-color: #28a745; color: white; }
        .status-danger { background-color: #dc3545; color: white; }
        .status-warning { background-color: #ffc107; color: black; }
        .status-info { background-color: #17a2b8; color: white; }
        .status-secondary { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI 분석 - {{ ticker }} ({{ market }})</h1>
        
        <!-- 디버그 정보 -->
        <div class="debug-info">
            <h3>디버그 정보</h3>
            <p><strong>ticker:</strong> {{ ticker }}</p>
            <p><strong>market:</strong> {{ market }}</p>
            <p><strong>indicators_data 존재:</strong> {{ indicators_data is not none }}</p>
            <p><strong>indicators_data 타입:</strong> {{ indicators_data.__class__.__name__ if indicators_data else 'None' }}</p>
            {% if indicators_data %}
            <p><strong>indicators_data 키:</strong> {{ indicators_data.keys() | list }}</p>
            {% if ticker in indicators_data %}
            <p><strong>{{ ticker }} 데이터 존재:</strong> True</p>
            <p><strong>{{ ticker }} 키:</strong> {{ indicators_data[ticker].keys() | list if indicators_data[ticker] else 'None' }}</p>
            {% if indicators_data[ticker] and 'indicators' in indicators_data[ticker] %}
            <p><strong>indicators 키:</strong> {{ indicators_data[ticker]['indicators'].keys() | list if indicators_data[ticker]['indicators'] else 'None' }}</p>
            {% endif %}
            {% if indicators_data[ticker] and 'analysis' in indicators_data[ticker] %}
            <p><strong>analysis 키:</strong> {{ indicators_data[ticker]['analysis'].keys() | list if indicators_data[ticker]['analysis'] else 'None' }}</p>
            {% endif %}
            {% else %}
            <p><strong>{{ ticker }} 데이터 존재:</strong> False</p>
            {% endif %}
            {% endif %}
        </div>

        <!-- 기술적 지표 테이블 -->
        <h2>기술적 지표</h2>
        {% if indicators_data and ticker in indicators_data and indicators_data[ticker] %}
            {% if indicators_data[ticker].get('indicators') or indicators_data[ticker].get('analysis') %}
                <table>
                    <thead>
                        <tr>
                            <th>지표명</th>
                            <th>값</th>
                            <th>상태</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- EMA 배열 -->
                        <tr>
                            <td><strong>EMA 배열</strong></td>
                            <td>
                                {% if indicators_data[ticker].get('analysis') and indicators_data[ticker]['analysis'].get('ema_array') %}
                                    {{ indicators_data[ticker]['analysis']['ema_array']['full_array'] }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if indicators_data[ticker].get('analysis') and indicators_data[ticker]['analysis'].get('ema_array') %}
                                    {% set ema_array = indicators_data[ticker]['analysis']['ema_array']['full_array'] %}
                                    {% if 'C>E5>E20>E40' in ema_array %}
                                        <span class="status-badge status-success">상승</span>
                                    {% elif 'E40>E20>E5>C' in ema_array %}
                                        <span class="status-badge status-danger">하락</span>
                                    {% else %}
                                        <span class="status-badge status-warning">중립</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge status-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- 종가-EMA20 Gap -->
                        <tr>
                            <td><strong>종가-EMA20 Gap</strong></td>
                            <td>
                                {% if indicators_data[ticker].get('analysis') and indicators_data[ticker]['analysis'].get('gap_ema20') %}
                                    {{ "%.2f"|format(indicators_data[ticker]['analysis']['gap_ema20']) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if indicators_data[ticker].get('analysis') and indicators_data[ticker]['analysis'].get('gap_ema20') %}
                                    {% if indicators_data[ticker]['analysis']['gap_ema20'] > 0 %}
                                        <span class="status-badge status-success">양수</span>
                                    {% else %}
                                        <span class="status-badge status-danger">음수</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge status-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- 종가-EMA40 Gap -->
                        <tr>
                            <td><strong>종가-EMA40 Gap</strong></td>
                            <td>
                                {% if indicators_data[ticker].get('analysis') and indicators_data[ticker]['analysis'].get('gap_ema40') %}
                                    {{ "%.2f"|format(indicators_data[ticker]['analysis']['gap_ema40']) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if indicators_data[ticker].get('analysis') and indicators_data[ticker]['analysis'].get('gap_ema40') %}
                                    {% if indicators_data[ticker]['analysis']['gap_ema40'] > 0 %}
                                        <span class="status-badge status-success">양수</span>
                                    {% else %}
                                        <span class="status-badge status-danger">음수</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge status-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- RSI -->
                        <tr>
                            <td><strong>RSI</strong></td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {{ "%.2f"|format(indicators_data[ticker]['indicators'].rsi) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {% if indicators_data[ticker]['indicators'].rsi > 70 %}
                                        <span class="status-badge status-danger">과매수</span>
                                    {% elif indicators_data[ticker]['indicators'].rsi < 30 %}
                                        <span class="status-badge status-success">과매도</span>
                                    {% else %}
                                        <span class="status-badge status-warning">중립</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge status-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- Stochastic %K -->
                        <tr>
                            <td><strong>Stochastic %K</strong></td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {{ "%.2f"|format(indicators_data[ticker]['indicators'].stoch_k) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {% if indicators_data[ticker]['indicators'].stoch_k > 80 %}
                                        <span class="status-badge status-danger">과매수</span>
                                    {% elif indicators_data[ticker]['indicators'].stoch_k < 20 %}
                                        <span class="status-badge status-success">과매도</span>
                                    {% else %}
                                        <span class="status-badge status-warning">중립</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge status-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- Stochastic %D -->
                        <tr>
                            <td><strong>Stochastic %D</strong></td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {{ "%.2f"|format(indicators_data[ticker]['indicators'].stoch_d) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {% if indicators_data[ticker]['indicators'].stoch_d > 80 %}
                                        <span class="status-badge status-danger">과매수</span>
                                    {% elif indicators_data[ticker]['indicators'].stoch_d < 20 %}
                                        <span class="status-badge status-success">과매도</span>
                                    {% else %}
                                        <span class="status-badge status-warning">중립</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge status-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- 5일 평균 거래량 대비 -->
                        <tr>
                            <td><strong>5일 평균 거래량 대비</strong></td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {{ "%.2f"|format(indicators_data[ticker]['indicators'].volume_ratio_5d) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {% if indicators_data[ticker]['indicators'].volume_ratio_5d > 150 %}
                                        <span class="status-badge status-success">높음</span>
                                    {% elif indicators_data[ticker]['indicators'].volume_ratio_5d < 50 %}
                                        <span class="status-badge status-warning">낮음</span>
                                    {% else %}
                                        <span class="status-badge status-info">보통</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge status-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- 20일 평균 거래량 대비 -->
                        <tr>
                            <td><strong>20일 평균 거래량 대비</strong></td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {{ "%.2f"|format(indicators_data[ticker]['indicators'].volume_ratio_20d) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {% if indicators_data[ticker]['indicators'].volume_ratio_20d > 150 %}
                                        <span class="status-badge status-success">높음</span>
                                    {% elif indicators_data[ticker]['indicators'].volume_ratio_20d < 50 %}
                                        <span class="status-badge status-warning">낮음</span>
                                    {% else %}
                                        <span class="status-badge status-info">보통</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge status-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- 40일 평균 거래량 대비 -->
                        <tr>
                            <td><strong>40일 평균 거래량 대비</strong></td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {{ "%.2f"|format(indicators_data[ticker]['indicators'].volume_ratio_40d) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if indicators_data[ticker].get('indicators') %}
                                    {% if indicators_data[ticker]['indicators'].volume_ratio_40d > 150 %}
                                        <span class="status-badge status-success">높음</span>
                                    {% elif indicators_data[ticker]['indicators'].volume_ratio_40d < 50 %}
                                        <span class="status-badge status-warning">낮음</span>
                                    {% else %}
                                        <span class="status-badge status-info">보통</span>
                                    {% endif %}
                                {% else %}
                                    <span class="status-badge status-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            {% else %}
                <p>지표 데이터가 없습니다.</p>
            {% endif %}
        {% else %}
            <p>데이터를 불러올 수 없습니다.</p>
        {% endif %}
    </div>
</body>
</html> 